name: Update Alaska HRRR Data

on:
  schedule:
    # Run every 3 hours to match Alaska HRRR update frequency
    - cron: '15 0,3,6,9,12,15,18,21 * * *'
  workflow_dispatch:  # Allow manual triggering
  push:
    branches:
      - main
      - claude/**

concurrency:
  group: data-update
  cancel-in-progress: false

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Free up disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h

          # Remove unnecessary pre-installed software
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL

          # Clean package manager caches
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

          echo "=== Disk space after cleanup ==="
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone - only fetch latest commit

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Create necessary directories
        run: |
          mkdir -p data
          mkdir -p catalog
          mkdir -p data_summary

      - name: Install package
        run: |
          uv pip install --system -e .

      - name: Run operational update
        timeout-minutes: 60
        run: |
          set -e  # Exit on any error
          uv run ak-hrrr operational-update noaa-hrrr-alaska-forecast \
            --output data/noaa-hrrr-alaska-forecast.zarr
        env:
          PYTHONUNBUFFERED: 1

      - name: Verify Zarr store was created
        run: |
          if [ ! -f "data/noaa-hrrr-alaska-forecast.zarr/.zmetadata" ]; then
            echo "ERROR: Zarr store metadata was not created!"
            echo "Contents of data directory:"
            ls -la data/
            exit 1
          fi

          # Check that at least one variable has actual data chunks (not just .zarray/.zattrs)
          # Variables should have chunk files like t2m/0.0.0.0 or similar
          data_chunks=$(find data/noaa-hrrr-alaska-forecast.zarr/t2m -type f ! -name ".z*" 2>/dev/null | wc -l)
          if [ "$data_chunks" -eq 0 ]; then
            echo "ERROR: Zarr store structure exists but NO VARIABLE DATA was written!"
            echo "This means the operational update failed to populate weather data."
            echo ""
            echo "Checking what files exist for t2m variable:"
            ls -la data/noaa-hrrr-alaska-forecast.zarr/t2m/ || echo "t2m directory not found"
            echo ""
            echo "Checking for any data chunks in entire store:"
            find data/noaa-hrrr-alaska-forecast.zarr -type f ! -name ".z*" | head -20
            exit 1
          fi

          echo "âœ… Zarr store created successfully with $data_chunks data chunk(s) for t2m variable"

      - name: Generate catalog metadata
        run: |
          uv run python scripts/generate_catalog.py

      - name: Create summary document
        run: |
          # Create summary of zarr store
          echo "Alaska HRRR Zarr Dataset" > data_summary/README.md
          echo "========================" >> data_summary/README.md
          echo "" >> data_summary/README.md
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> data_summary/README.md
          echo "" >> data_summary/README.md

          if [ -d "data/noaa-hrrr-alaska-forecast.zarr" ]; then
            SIZE=$(du -sh data/noaa-hrrr-alaska-forecast.zarr | cut -f1)
            echo "Dataset: noaa-hrrr-alaska-forecast.zarr ($SIZE)" >> data_summary/README.md
          fi

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Debug - Check what will be committed
        run: |
          echo "=== Files in data directory ==="
          ls -lh data/ || echo "No data directory"
          echo ""
          echo "=== Size of zarr store ==="
          du -sh data/noaa-hrrr-alaska-forecast.zarr || echo "No zarr store"
          echo ""
          echo "=== Git status before add ==="
          git status

      - name: Commit and push changes
        run: |
          # Add files
          git add catalog/ data_summary/

          # For zarr data, add with force to ensure large files are included
          git add -f data/noaa-hrrr-alaska-forecast.zarr/ || echo "Warning: Could not add zarr store"

          echo "=== Git status after add ==="
          git status

          if ! git diff --staged --quiet; then
            TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
            SIZE=$(du -sh data/noaa-hrrr-alaska-forecast.zarr 2>/dev/null | cut -f1 || echo "unknown")

            git commit -m "Update Alaska HRRR data - $TIMESTAMP" \
              -m "Zarr store size: $SIZE" \
              -m "This commit includes the complete zarr directory structure with all data chunks"

            echo "=== Commit created, preparing to push ==="
            echo "Repository size:"
            du -sh .git

            # Try to push with increased buffer and timeout
            git config http.postBuffer 524288000  # 500MB buffer
            git config http.lowSpeedLimit 0
            git config http.lowSpeedTime 999999

            # Retry push up to 3 times
            for attempt in 1 2 3; do
              echo "Push attempt $attempt of 3..."
              if timeout 600 git push; then  # 10 minute timeout
                echo "Successfully pushed on attempt $attempt"
                break
              elif [ $attempt -lt 3 ]; then
                echo "Push failed on attempt $attempt, retrying..."
                sleep 10
              else
                echo "Failed to push after 3 attempts"
                echo "This may be due to large file size. Consider using Git LFS or cloud storage."
                exit 1
              fi
            done
          else
            echo "No changes to commit"
          fi

      - name: Monitor final disk space
        if: always()
        run: |
          echo "=== Final disk space usage ==="
          df -h
          echo "=== Repository size ==="
          du -sh .git
          echo "=== Data directory size ==="
          du -sh data/ || echo "No data directory"

      - name: Upload catalog for Pages deployment
        uses: actions/upload-artifact@v4
        with:
          name: catalog-artifact
          path: catalog/
          retention-days: 1

  deploy-catalog:
    needs: update-data
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Download catalog artifact
        uses: actions/download-artifact@v4
        with:
          name: catalog-artifact
          path: catalog

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './catalog'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
