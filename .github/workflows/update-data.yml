name: Update Alaska HRRR Data

on:
  # Run every 3 hours to match Alaska HRRR update frequency
  schedule:
    - cron: '15 0,3,6,9,12,15,18,21 * * *'  # 15 minutes after each cycle

  # Allow manual triggering
  workflow_dispatch:

  # Run on push to main for testing
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

# Only allow one update at a time
concurrency:
  group: data-update
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Free up disk space
        run: |
          echo "=== Initial disk space ==="
          df -h /

          # Remove unnecessary large packages to free ~30GB
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift

          # Clean apt cache
          sudo apt-get clean

          echo "=== Disk space after cleanup ==="
          df -h /

      - name: Checkout repository (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone to save space

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync --all-extras

      - name: Create directories
        run: |
          mkdir -p data downloads

      - name: Run operational update
        run: |
          # Determine the most recent valid HRRR cycle
          CURRENT_HOUR=$(date -u +"%H")
          CYCLE_HOUR=$((CURRENT_HOUR / 3 * 3))
          CYCLE_HOUR=$(printf "%02d" $CYCLE_HOUR)

          TIMESTAMP=$(date -u +"%Y%m%d")_${CYCLE_HOUR}
          OUTPUT_DIR="data/hrrr_alaska_${TIMESTAMP}.zarr"

          echo "Current UTC hour: $CURRENT_HOUR"
          echo "Using HRRR cycle: $CYCLE_HOUR UTC"
          echo "Creating Zarr store: $OUTPUT_DIR"

          echo "=== Disk space before download ==="
          df -h /

          uv run ak-hrrr operational-update noaa-hrrr-alaska-forecast \
            --output "$OUTPUT_DIR"

          echo "ZARR_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          echo "ZARR_DIR=$OUTPUT_DIR" >> $GITHUB_ENV

          echo "=== Disk space after download ==="
          df -h /
        env:
          PYTHONUNBUFFERED: 1

      - name: Clean up downloads
        run: |
          rm -rf downloads/*
          echo "=== Disk space after cleaning downloads ==="
          df -h /

      - name: Generate catalog metadata
        run: |
          uv run python scripts/generate_catalog.py

      - name: Generate data summary
        run: |
          mkdir -p data_summary

          cat > data_summary/README.md << EOF
          # Alaska HRRR Zarr Datasets

          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Latest Forecast
          - ${ZARR_DIR}

          ## Data Access
          Catalog metadata is available at GitHub Pages.
          Data is regenerated every 3 hours from NOAA sources.
          EOF

      - name: Commit catalog metadata only (no data)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Only add catalog and summary - NOT the data
          git add catalog/
          git add data_summary/
          git add .gitignore

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "Update Alaska HRRR catalog - $TIMESTAMP"

            # Push with retry logic
            for i in 1 2 3 4; do
              if git push; then
                echo "Push successful"
                break
              else
                echo "Push failed, attempt $i of 4"
                [ $i -lt 4 ] && sleep $((2 ** i))
              fi
            done
          fi

      - name: Upload catalog artifact
        uses: actions/upload-artifact@v4
        with:
          name: hrrr-catalog-${{ github.run_number }}
          path: |
            catalog/
            data_summary/
          retention-days: 1
        if: always()

  deploy-pages:
    needs: update
    runs-on: ubuntu-latest

    steps:
      - name: Download catalog artifact
        uses: actions/download-artifact@v4
        with:
          name: hrrr-catalog-${{ github.run_number }}
          path: ./

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: catalog/

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
